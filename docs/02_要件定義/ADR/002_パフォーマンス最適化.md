# ADR-002: GeoJSONファイルサイズとレンダリングパフォーマンス

## ステータス
採用 (Accepted)

## 日付
2026-01-02

## コンテキスト
日本全国約1,700市町村のコロプレスマップを表示するにあたり、ファイルサイズとレンダリングパフォーマンスの課題を整理し、対策を決定する必要がある。

---

## 課題

### 1. ファイルサイズ

| データ形式 | 全国データサイズ | 課題 |
|-----------|------------------|------|
| GeoJSON（未圧縮） | 50-100 MB | 初期読み込みに10-30秒 |
| TopoJSON（簡素化） | 5-15 MB | 許容範囲だが改善余地あり |
| TopoJSON + Gzip | 1-3 MB | 実用的 ✅ |

### 2. レンダリングパフォーマンス

| 課題 | 影響 | 発生条件 |
|------|------|----------|
| 初期描画の遅延 | 1-2秒のブロッキング | ポリゴン数1,000超 |
| メモリ使用量増加 | 100-200MB | 全国データ読み込み時 |
| ズーム時のラグ | フレームレート低下 | 複雑なポリゴン多数 |

---

## 対策

### 現在の実装（Phase 1）

| 対策 | 実装状況 |
|------|----------|
| **サンプルデータ限定** | 東京23区のみ（23ポリゴン） |
| **事前スコア結合** | Mapshaperスクリプトで静的に結合 |
| **MapLibre GPU加速** | WebGLによる高速レンダリング |

### 今後の対策（Phase 2: 全国対応時）

#### A. データ最適化

```bash
# TopoJSON変換（SmartNews SMRI版を使用）
# 簡素化率 s0010 = 1% 許容誤差（推奨）

# Gzip圧縮（サーバー/CDN設定）
Content-Encoding: gzip
```

#### B. レンダリング最適化

| 手法 | 説明 |
|------|------|
| **レベル別表示** | ズームレベルで表示ポリゴン量を調整 |
| **遅延読み込み** | 表示範囲のみGeoJSON取得 |
| **ベクタータイル** | PMTiles/MVT形式への移行（要検討） |

#### C. MapLibre設定

```typescript
// 推奨設定
map.addSource('municipalities', {
  type: 'geojson',
  data: geojson,
  tolerance: 0.5,  // 簡素化許容値
  buffer: 128,     // タイルバッファ
  maxzoom: 14      // 最大ズーム制限
});
```

---

## 検証結果（現時点）

| 項目 | 東京23区 | 予測（全国） |
|------|----------|--------------|
| ファイルサイズ | 60 KB | 3-5 MB (Gzip) |
| 初期描画時間 | < 100ms | 500ms-1s |
| メモリ使用量 | 5 MB | 100-150 MB |
| フレームレート | 60fps | 50-60fps |

---

## 決定事項

1. **Phase 1**: サンプルデータ（東京23区）で機能実装を優先
2. **Phase 2**: SmartNews SMRI TopoJSON（s0010簡素化版）+ Gzip圧縮で全国対応
3. **Phase 3**: パフォーマンス問題発生時にベクタータイル移行を検討

## 参考リンク
- [Optimising MapLibre Performance](https://maplibre.org/maplibre-gl-js/docs/guides/large-data/)
- [SmartNews SMRI japan-topography](https://github.com/smartnews-smri/japan-topography)
