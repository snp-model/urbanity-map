# 都会度データ算出アルゴリズム

本ドキュメントでは、Rawデータから「都会度スコア (Urbanity Score)」を算出するまでの処理フローとアルゴリズムについて解説します。

## 全体概要

都会度スコアは、以下の4つの独立した指標を算出し、それらを主成分分析（PCA）を用いて統合することで生成されます。

1.  **夜間光 (Night Lights)**: 衛星データによる地上の明るさ
2.  **人口 (Population)**: 国土数値情報の人口メッシュデータ
3.  **POI (Points of Interest)**: 飲食店やコンビニなどの店舗密度
4.  **地価 (Land Price)**: 国土数値情報の地価公示データ

これらを市区町村ごとに集計・スコア化し、最終的に0〜100の「都会度スコア」として算出します。

また、都会度スコアとは別に、以下の**追加統計データ**も表示用に収集しています：
- 人口増加率、高齢者割合、課税所得

```mermaid
graph TD
    A[Raw Data] --> B{個別処理}
    B --> C[夜間光スコア]
    B --> D[人口スコア]
    B --> E[POI密度スコア]
    C & D & E --> F["統合処理 (PCA)"]
    F --> G[都会度スコア]

    H[追加統計データ] --> I[表示用データ]
    G --> J[最終成果物]
    I --> J

    subgraph "Raw Data Sources"
        R1["VIIRS Night Lights<br>(GeoTIFF)"]
        R2["国土数値情報 人口メッシュ<br>(GeoJSON)"]
        R3["OpenStreetMap<br>(PBF)"]
    end

    subgraph "追加データソース"
        S1["e-Stat 国勢調査<br>(Excel)"]
        S2["国土数値情報 地価<br>(GeoJSON)"]
        S3["e-Stat 課税所得<br>(CSV)"]
    end

    subgraph "中間スコア (0-100)"
        C
        D
        E
    end

    subgraph "Output"
        J[urbanity-score-v2.json<br>japan-with-scores-v2.geojson]
    end

    R1 --> C
    R2 --> D
    R3 --> E
    S1 --> H
    S2 --> H
    S3 --> H
```

---

## 1. 個別スコアの算出

各指標の算出ロジックは共通の正規化手法を用いています。

### 正規化ロジック (共通)
各指標のRaw値は分布が大きく偏っている（都市部と地方部で桁が異なる）ため、対数変換を行ってから0-100に正規化しています。

$$ Score = \frac{\log_{10}(x + 1) - \min}{\max - \min} \times 100 $$

*   $x$: Raw値（平均放射輝度、総人口、店舗密度）
*   $\log_{10}(x+1)$: 0値の対数エラーを防ぐための補正付き対数変換
*   Min-Max Scaling: 全自治体の中での相対位置を0-100で表現

---

### A. 夜間光スコアプロセス (`process_night_lights.py`)

*   **データソース**: VIIRS Annual Composite (GeoTIFF)
*   **処理単位**: 市区町村ポリゴンごとの平均値 (Zonal Statistics)
*   **算出値**: 平均放射輝度 (Average Radiance)
*   **目的**: 都市の物理的な明るさ、エネルギー消費量を反映

### B. 人口スコアプロセス (`process_population.py`)

*   **データソース**: 国土数値情報 500mメッシュ人口推計 (GeoJSON/JSON)
*   **処理方法**:
    1.  人口メッシュの重心点を作成
    2.  市区町村ポリゴンと空間結合 (Spatial Join)
    3.  市区町村内のメッシュ人口を合計
*   **算出値**: 市区町村内の総人口
*   **目的**: 人の居住密度、都市の規模を反映

### C. POI密度スコアプロセス (`process_poi.py`)

*   **データソース**: OpenStreetMap (OSM) PBFデータ
*   **抽出対象**:
    *   `shop`: `convenience`, `supermarket`
    *   `amenity`: `restaurant`, `cafe`, `fast_food`, `bar`, `pub`, `izakaya`
*   **処理方法**:
    1.  対象タグを持つノードを抽出
    2.  市区町村ポリゴンと空間結合
    3.  市区町村ごとの店舗数を集計
    4.  市区町村の面積($km^2$)で割って密度を算出
*   **算出値**: 店舗密度 (店舗数 / $km^2$)
*   **目的**: 商業的な活気、利便性を反映

---

## 2. 追加統計データ

都会度スコアの算出には使用しませんが、UI表示用に以下の統計データを収集しています。

### D. 人口統計データ (`process_demographics.py`)

*   **データソース**: 
    - e-Stat 令和2年国勢調査 人口等基本集計 (`b01_01.xlsx`)
    - e-Stat 令和2年国勢調査 年齢別人口 (`b03_03.xlsx`)
*   **算出値**:
    - **人口増加率 (pop_growth)**: 2015年→2020年の5年間の人口増減率 (%)
    - **高齢者割合 (elderly_ratio)**: 65歳以上人口 / 総人口 × 100 (%)
*   **目的**: 人口動態の傾向を表示

### E. 地価データ (`process_land_price.py`)

*   **データソース**: 国土数値情報 地価公示データ (`L01-25.geojson`)
*   **処理方法**: 市区町村内の地価ポイントの中央値を算出
*   **算出値**: 地価中央値 (円/㎡)
*   **目的**: 土地の経済的価値を表示

### F. 課税所得データ (`process_tax.py`)

*   **データソース**: e-Stat 市町村税課税状況等の調 (`J51-24-b*.csv`)
*   **算出値**: 1人当たり課税所得 (万円)
*   **目的**: 住民の経済力を表示

---

## 3. 統合スコアの算出 (`integrate_scores.py`)

4つのスコア（夜間光、人口、POI、地価）を統合して、一つの「都会度」指標を作成します。単純平均ではなく、データの分散を最もよく説明できる軸を抽出するために**主成分分析 (Principal Component Analysis - PCA)** を使用しています。

### 手順

1.  **入力**: 各指標の正規化済みスコア・実数値
2.  **前処理**: 対数変換 ($\log(1+x)$) を適用し、分布の偏りを緩和
3.  **標準化**: 平均0、分散1にデータをスケーリング (`StandardScaler`)
4.  **PCA実行**: 第1主成分（最も情報のばらつきが大きい軸）を抽出
5.  **重み付け**: 第1主成分への寄与度（Eigenvectors）に基づいて、各指標の重要度が決定されます。
    *   *最新の結果: 夜間光:人口:POI:地価 = 0.26 : 0.23 : 0.26 : 0.24*
    *   *第一主成分の寄与率: 0.74*
6.  **最終正規化**: PCAスコアを再度 0-100 の範囲に Min-Max 正規化

### 出力ファイル

*   `urbanity-score-v2.json`: 各市区町村コードをキーとしたスコアデータ。以下のフィールドを含む:
    - `urbanity`: 都会度スコア (0-100)
    - `light_pollution`: 光害度スコア (0-100)
    - `population_count`: 人口
    - `poi_count`: POI数
    - `poi_density`: POI密度
    - `land_price`: 地価中央値
    - `avg_income`: 1人当たり課税所得
    - `pop_growth`: 人口増加率 (%)
    - `elderly_ratio`: 高齢者割合 (%)
*   `japan-with-scores-v2.geojson`: 地図表示用。GeoJSONの各Featureにスコアを埋め込んだもの。

---

## まとめ

このアルゴリズムの特徴は、**「明るさ」「人の数」「商業密度」という異なる3つの次元から多角的に「都会」を定義している点**にあります。PCAを用いることで、人為的な重み付け（例：人口を2倍にする等）を排除し、データ自身の構造から自然な「都会度」の軸を導き出しています。

さらに、人口動態（増加率・高齢化率）や経済指標（地価・所得）などの追加統計も収集することで、単なる都会度だけでなく、各市区町村の多角的な特徴を把握できるようになっています。
